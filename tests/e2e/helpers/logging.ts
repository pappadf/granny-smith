// SPDX-License-Identifier: MIT
// Copyright (c) pappadf

// moved from tests/utils/logging.ts unchanged
import type { Page, TestInfo } from '@playwright/test';
export interface TestLogger { log: (msg: string) => void; startTime: number; logs: string[]; consoleLogs: string[]; attachAll: (testInfo: TestInfo, opts?: { allName?: string; consoleName?: string }) => Promise<void>; }
export interface InitLoggingOptions { captureNetwork?: boolean; captureConsole?: boolean; testInfo?: TestInfo; label?: string; }
export function initLogging(page: Page, opts: InitLoggingOptions = {}): TestLogger { const { captureNetwork = true, captureConsole = true, label = 'test' } = opts; const startTime = Date.now(); const logs: string[] = []; const consoleLogs: string[] = []; const log = (m: string) => { const line = `+${(Date.now()-startTime).toString().padStart(5,' ')}ms ${m}`; console.log(line); logs.push(line); }; log(`[${label}] logging start`); if(captureNetwork){ page.on('request', r=>{ try { log(`[net:req] ${r.method()} ${r.url()}`);}catch{}}); page.on('requestfailed', r=>{ try { log(`[net:fail] ${r.method()} ${r.url()} -> ${r.failure()?.errorText}`);}catch{}}); page.on('response', r=>{ try { log(`[net:res] ${r.status()} ${r.url()}`);}catch{}}); } if(captureConsole){ page.on('console', msg=>{ try { const txt = msg.text(); const line = `[console:${msg.type()}] ${txt}`; log(line); consoleLogs.push(logs[logs.length-1]); } catch {} }); } async function attachAll(testInfo: TestInfo, aOpts: { allName?: string; consoleName?: string } = {}) { const { allName='test-log.txt', consoleName='console-log.txt'} = aOpts; try { if(logs.length) await testInfo.attach(allName,{ body: Buffer.from(logs.join('\n'),'utf8'), contentType:'text/plain'}); if(consoleLogs.length) await testInfo.attach(consoleName,{ body: Buffer.from(consoleLogs.join('\n'),'utf8'), contentType:'text/plain'}); } catch {} } return { log, startTime, logs, consoleLogs, attachAll }; }
