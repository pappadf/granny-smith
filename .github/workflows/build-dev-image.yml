name: Build & Publish Dev Image

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      # Rebuild only when the actual Docker build context or workflow changes.
      # devcontainer/devcontainer.json edits (extensions, ports, postCreateCommand, etc.)
      # should NOT force an image rebuild; they are applied at container creation time.
      - ".devcontainer/Dockerfile"
      - "Dockerfile"
      - "docker/**"
      - ".github/workflows/build-dev-image.yml"

concurrency:
  group: dev-image-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image metadata
        id: meta
        run: |
          IMAGE_NAME="ghcr.io/pappadf/granny-smith-dev"
          TAG_BASE="ubuntu24-emsdk4.0.10-nodeLTS"
          echo "image=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "tag=${TAG_BASE}" >> $GITHUB_OUTPUT

      - name: Set up QEMU (optional multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Build & Push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: .devcontainer/Dockerfile
          push: true
          # NOTE: add more platforms if you want multi-arch (e.g., linux/arm64)
          platforms: linux/amd64
          labels: |
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.description=Dev image with Emscripten 4.0.10, Node LTS, C/C++ toolchain
            org.opencontainers.image.revision=${{ github.sha }}
          tags: |
            ${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.tag }}
            ${{ steps.meta.outputs.image }}:latest
          cache-from: type=registry,ref=${{ steps.meta.outputs.image }}:cache
          cache-to: type=registry,ref=${{ steps.meta.outputs.image }}:cache,mode=max

      - name: Resolve digest for immutable pin
        id: digest
        run: |
          DIGEST=$(skopeo inspect --no-tags docker://${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.tag }} | jq -r '.Digest')
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
        env:
          # skopeo is preinstalled on GitHub-hosted runners; if not, apt-get install skopeo -y
          # jq is also available; otherwise apt-get install -y jq
          # Nothing else required
          XDG_RUNTIME_DIR: /tmp

      - name: Save digest artifact
        run: |
          echo "${{ steps.meta.outputs.image }}@${{ steps.digest.outputs.digest }}" > image_digest.txt
        shell: bash
