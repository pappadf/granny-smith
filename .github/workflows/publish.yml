# Deploy WASM build to the gs-pages deployment repository on GitHub Pages.
#
# Trigger: Publishing a GitHub Release (tag like v1.0.0).
#
# This workflow:
#   1. Builds the WASM emulator (release mode) inside the dev container.
#   2. Clones the gs-pages deployment repository.
#   3. Copies build artifacts into a versioned folder AND /latest/.
#   4. Regenerates the landing page (index.html) listing all versions.
#   5. Pushes the changes to gs-pages, which publishes via GitHub Pages.
#
# Required secrets:
#   DEPLOY_TOKEN  — a GitHub PAT (fine-grained) with Contents: Read & Write
#                   permission on the pappadf/gs-pages repository.

name: Publish to GitHub Pages

on:
  release:
    types: [published]

# Allow only one publish at a time to avoid push conflicts
concurrency:
  group: publish
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-24.04
    container:
      image: ghcr.io/pappadf/granny-smith-dev:ubuntu24-emsdk4.0.10-nodeLTS
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      # 1. Checkout source (with peeler submodule)
      - name: Checkout source
        uses: actions/checkout@v6
        with:
          submodules: recursive
          path: source

      # 2. Build the WASM emulator (release mode)
      - name: Build WASM (release)
        working-directory: ./source
        run: |
          make clean && make

      # 3. Checkout the deployment repository
      - name: Checkout gs-pages
        uses: actions/checkout@v6
        with:
          repository: pappadf/gs-pages
          token: ${{ secrets.DEPLOY_TOKEN }}
          path: deploy

      # 4. Copy build artifacts into versioned folder + /latest/
      - name: Place artifacts
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          echo "Deploying version: $VERSION"

          # Files to deploy (everything in build/ except intermediate objects
          # and headless binaries)
          DEPLOY_FILES="index.html main.mjs main.wasm style.css js"

          # --- Versioned folder ---
          mkdir -p "deploy/$VERSION"
          for f in $DEPLOY_FILES; do
            cp -r "source/build/$f" "deploy/$VERSION/"
          done

          # --- /latest/ (overwrite) ---
          rm -rf deploy/latest
          mkdir -p deploy/latest
          for f in $DEPLOY_FILES; do
            cp -r "source/build/$f" deploy/latest/
          done

      # 5. Generate the landing page listing all deployed versions
      - name: Generate landing page
        working-directory: ./deploy
        run: |
          python3 << 'LANDING'
          import os, re

          # Collect versioned directories (anything that looks like v1.2.3)
          dirs = [
              d for d in os.listdir(".")
              if os.path.isdir(d)
              and re.match(r"v?\d", d)
              and d not in ("latest",)
          ]
          dirs.sort(key=lambda d: list(map(int, re.findall(r"\d+", d))), reverse=True)

          latest_label = dirs[0] if dirs else "–"

          html = f"""\
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="utf-8" />
            <title>Granny Smith — Releases</title>
            <style>
              * {{ box-sizing: border-box; }}
              body {{
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica,
                             Arial, sans-serif;
                max-width: 640px; margin: 3rem auto; padding: 0 1rem;
                color: #24292f; background: #fff;
              }}
              h1 {{ font-size: 1.6rem; }}
              a {{ color: #0969da; text-decoration: none; }}
              a:hover {{ text-decoration: underline; }}
              .card {{
                border: 1px solid #d0d7de; border-radius: 6px;
                padding: 12px 16px; margin: 8px 0;
              }}
              .latest {{ background: #dafbe1; border-color: #2da44e; }}
              .latest .badge {{
                display: inline-block; background: #2da44e; color: #fff;
                font-size: 0.75rem; padding: 2px 8px; border-radius: 12px;
                margin-left: 8px; vertical-align: middle;
              }}
              hr {{ border: none; border-top: 1px solid #d0d7de; margin: 1.5rem 0; }}
              .muted {{ color: #656d76; font-size: 0.9rem; }}
            </style>
          </head>
          <body>
            <h1>Granny Smith Emulator</h1>

            <div class="card latest">
              <strong><a href="latest/">Launch Latest</a></strong>
              <span class="badge">{latest_label}</span>
              <div class="muted">Always points to the newest release.</div>
            </div>

            <hr>
            <h3>All Versions</h3>
          """

          for d in dirs:
              html += f'  <div class="card"><a href="{d}/">{d}</a></div>\n'

          html += """\
            <hr>
            <p class="muted">
              Powered by <a href="https://github.com/pappadf/granny-smith">Granny Smith</a>.
            </p>
          </body>
          </html>
          """

          import textwrap
          with open("index.html", "w") as f:
              f.write(textwrap.dedent(html))

          print(f"Landing page generated with {len(dirs)} version(s).")
          LANDING

      # 6. Ensure .nojekyll exists (so GitHub Pages serves .mjs / .wasm)
      - name: Ensure .nojekyll
        working-directory: ./deploy
        run: touch .nojekyll

      # 7. Commit and push to gs-pages
      - name: Push to gs-pages
        working-directory: ./deploy
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add --all
          git commit -m "Deploy ${{ github.event.release.tag_name }}"
          git push origin main
